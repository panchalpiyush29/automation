# How to write awesome markdown file
https://stackedit.io/editor

http://dillinger.io/

# How to launch the rest service
## On IntelliJ 
Run `nz.co.automation.rest.RestApplication`

## On Commandline
Run `mvn spring-boot:run`

# How to access h2-console 
* Set `spring.h2.console.enabled=true`
* Console is accessible on url `localhost:8089/h2-console`

# How to access postgres database on Docker
* Pull docker image for postgres `docker pull postgres`
* Show running docker containers `docker ps`

You should see something like this
```
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                                              NAMES
8da59f852a52        postgres            "docker-entrypoint..."   2 days ago          Up 2 days           0.0.0.0:5430->5432/tcp                             goofy_shockley
```

* If there is no postgres container, the container either has been stopped or does not exist.
* Show all docker containers `docker ps -a`
* If postgres container is stopped then start it up `docker start <container id>`
* If postgres container is not in the list, look for the image then run a container from image.
```
# show all images
docker images

# run the container off the image
docker run -p 5430:5432 -d <image name>

# check docker is running on the correct port
docker ps    
```
* Then you should see this
```
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                                              NAMES
8da59f852a52        postgres            "docker-entrypoint..."   2 days ago          Up 2 days           0.0.0.0:5430->5432/tcp                             goofy_shockley
```
* Access docker and run bash
`docker exec -it <container id> bash`
* Run postgres client psql
```
psql -d <database name> -U <username>

# e.g.
psql -d automation_db -U automation

# check connection
\c
```

# Docker Postgres Database schema

## Create user and database
* `create user automation;`
* `alter role automation with password 'automation';`
* `create database automation_db;`
* `grant connect on database gasmon_db to gasmon;`
* `revoke connect on database gasmon_db from public;`

## Create table, data and sequence for the id
* Create table dogs with id generated from sequence_dog_id table
    ```
    create sequence sequence_dog_id;
    create table dogs(
        id int not null default nextval('sequence_dog_id') primary key,
        name varchar(200) not null,
        age int not null
    );
    alter sequence sequence_dog_id OWNED BY dogs.id;
    ```
* Create data
    ```
    insert into dogs(name, age)
    values('Chihuahua', 2);
    
    insert into dogs(name, age)
        values('Phu Quoc', 3);
    ```

# Troubleshooting for existing database
* If JPA complains about **"cannot find hibernate_sequence sequence"** then create one
 ```
 create sequence hibernate_sequence;
 ```
 
 > Note that the Dog domain POJO has id
 > ```
 > @Id
 > @GeneratedValue
 > @Column(name = "id")
 > private Integer id;
 > ```
 > This means the id is auto generated by JPA (not the database), JPA needs someway to generate the next number
 > thus it uses the sequence table to get the next number for the id.
 > Let's do to see what's in there.
 > ```
 > select * from hibernate_sequence;
 > ```
 
 * This steps allows database creation in the table.
 
 # PSQL commands
 ```
 # drop database
 drop database "database"
 drop role "user"
 drop user "user"
 
 # clean up used socket
 rm /usr/local/var/postgres/postmaster.pid
 
 # show all databases
 \l+
 
 # show all users\roles
 \du
 
 # show all tables
 \dt
 
 # connect to a database or username or both
 \c <database name - optional> <username - optional>
 ```
   
   
   
 